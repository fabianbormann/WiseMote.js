<html>
<head>
<style>
  body {font-family: 'Open Sans', sans-serif;}
  #result {margin-top: 30px;}
  td {padding:15px;}
</style>
<!-- Configuration: Please do not remove -->
<script src="/js/jquery-1.9.1.js"></script>
<script src="/js/virtual-remote.js"></script>
<script type="text/javascript">  
  jsMote = new JsMote();
  
  jsMote.addNode({
    id : "0x0001",
    led : false,
    light : 44,
    temperature : 18,
    delay : 500
  });
  
  jsMote.addNode({
    id : "0x0002",
    led : false,
    light : 9,
    temperature : 29,
    delay : 300
  });
</script>
<!-- End of Configuration -->
<script type="text/javascript">

	var nodesInExperiment = 0;

	var measurements = {
		length : 0,
		data : new Array
	} 

	function Measurement(type, payloadSize) {
		this.type = type;
		this.payload = Array(payloadSize).join('x');
		this.delta = [];
		this.roundTripTime = 0;

		this.now = new Date();

		var self = this;

		return function() {
			switch(self.type) {
				case "alert":
					jsMote.alert(self.payload, function() {
    					current = new Date();
    					rtt = current-self.now;
    					self.roundTripTime = addDelta(rtt, self.delta);
					});
					break;
				case "broadcast":
					jsMote.broadcast(self.payload, function() {
    					current = new Date();
    					rtt = current-self.now;
    					self.roundTripTime = addDelta(rtt, self.delta);
					});
					break;
				case "getLedState":
					jsMote.getLedState(function() {
    					current = new Date();
    					rtt = current-self.now;
    					self.roundTripTime = addDelta(rtt, self.delta);
					});
					break;
				case "switchLedState":
					jsMote.switchLed((Math.random() < 0.5), function() {
    					current = new Date();
    					rtt = current-self.now;
    					self.roundTripTime = addDelta(rtt, self.delta);
					});
					break;				
				case "getTemp":
					jsMote.getSensorValue("temperature", function() {
    					current = new Date();
    					rtt = current-self.now;
    					self.roundTripTime = addDelta(rtt, self.delta);
					});
					break;	
				case "getLight":
					jsMote.getSensorValue("light", function() {
    					current = new Date();
    					rtt = current-self.now;
    					self.roundTripTime = addDelta(rtt, self.delta);
					});
					break;	
				default:
					throw new Error("Unknown type: "+type);	
			}
		}()
	}

    function startMeasurment() {

    	measurements.data = [];

    	for(var i = 0; i < $('#measurements').val(); i++) {
			measurements.data.push(new Measurement( "alert", $('#payloadLength').val() ));
			measurements.data.push(new Measurement( "broadcast", $('#payloadLength').val() ));
			measurements.data.push(new Measurement( "getLedState", $('#payloadLength').val() ));
			measurements.data.push(new Measurement( "switchLedState", $('#payloadLength').val() ));
			measurements.data.push(new Measurement( "getTemp", $('#payloadLength').val() ));
			measurements.data.push(new Measurement( "getLight", $('#payloadLength').val() ));
		}

    }

    function addDelta(rtt, delta) {
    	deltaSum = 0;
    	delta.push(rtt);
    	for(var i = 0; i < delta.length; i++) {
    		deltaSum += delta[i];
    	}
    	updateView();
    	return (deltaSum/delta.length);
    }

    function updateView() {

    	var table = "<table><tr><td>Function</td><td>Measurements</td><td>Average Round Trip Time [ms]</td><td>Nodes in Experiment</td></tr>"

    	var alerts = [];
    	var broadcasts = [];
    	var switchLeds = [];
    	var ledStates = [];
    	var temps = [];
    	var ligths = [];

    	for(var i = 0; i < measurements.data.length; i++) {
    		if(measurements.data[i].type == "alert" && measurements.data[i].roundTripTime > 0) {
    			alerts.push(measurements.data[i].roundTripTime);
    		}
    		else if (measurements.data[i].type == "broadcast" && measurements.data[i].roundTripTime > 0) {
    			broadcasts.push(measurements.data[i].roundTripTime);
    		}
    		else if (measurements.data[i].type == "getLedState" && measurements.data[i].roundTripTime > 0) {
    			ledStates.push(measurements.data[i].roundTripTime);
    		}
    		else if (measurements.data[i].type == "switchLedState" && measurements.data[i].roundTripTime > 0) {
    			switchLeds.push(measurements.data[i].roundTripTime);
    		}
    		else if (measurements.data[i].type == "getTemp" && measurements.data[i].roundTripTime > 0) {
    			temps.push(measurements.data[i].roundTripTime);
    		}
    		else if (measurements.data[i].type == "getLight" && measurements.data[i].roundTripTime > 0) {
    			ligths.push(measurements.data[i].roundTripTime);
    		}
    	}
    	var rtt = 0;
    	$.each(alerts, function(index, value) {
    		rtt += value;
    	});

    	rtt = rtt/alerts.length;
    	table += "<tr><td>Alert</td><td>"+alerts.length+"</td><td>"+rtt+"</td><td>"+nodesInExperiment+"</td></tr>";
		
		rtt = 0;
    	$.each(broadcasts, function(index, value) {
    		rtt += value;
    	});
    	rtt = rtt/broadcasts.length;
    	table += "<tr><td>Broadcast</td><td>"+broadcasts.length+"</td><td>"+rtt+"</td><td>"+nodesInExperiment+"</td></tr>";

		rtt = 0;
    	$.each(switchLeds, function(index, value) {
    		rtt += value;
    	});
    	rtt = rtt/switchLeds.length;
    	table += "<tr><td>Switch Led</td><td>"+switchLeds.length+"</td><td>"+rtt+"</td><td>"+nodesInExperiment+"</td></tr>";

		rtt = 0;
    	$.each(ledStates, function(index, value) {
    		rtt += value;
    	});
    	rtt = rtt/ledStates.length;
    	table += "<tr><td>Get Led State</td><td>"+ledStates.length+"</td><td>"+rtt+"</td><td>"+nodesInExperiment+"</td></tr>";

		rtt = 0;
    	$.each(temps, function(index, value) {
    		rtt += value;
    	});
    	rtt = rtt/temps.length;
    	table += "<tr><td>Get Sensor Value (temperature)</td><td>"+temps.length+"</td><td>"+rtt+"</td><td>"+nodesInExperiment+"</td></tr>";

		rtt = 0;
    	$.each(ligths, function(index, value) {
    		rtt += value;
    	});
    	rtt = rtt/ligths.length;
    	table += "<tr><td>Get Sensor Value (light)</td><td>"+ligths.length+"</td><td>"+rtt+"</td><td>"+nodesInExperiment+"</td></tr></table><br><button onclick=\"console.log(measurements)\">Log complete data (console)</button>";

    	$("#result").html(table);
    }

    $( document ).ready(function() {
	    jsMote.alert("find", function(id, message) {
	    	nodesInExperiment++;
	    });
  	});
  </script>
</head>
<body>
  <h1>Round Trip Time</h1>
  <label for="measurements">Measurements</label>
  <input id="measurements" type="number" min="1" value="1" step="1" pattern="\d+"/><br>
  <label for="payloadLength">payload size (char count)</label>
  <input id="payloadLength" type="number" min="5" value="5" step="1" pattern="\d+"/>
  <button onclick="startMeasurment();">Start measurement</button>
  <br>
  <div id="result"></div>
</body>
</html>