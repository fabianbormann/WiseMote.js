<html>
<head>
<style>
  body {font-family: 'Open Sans', sans-serif;}
    #localization {background-color: #eee}
</style>
<!-- Configuration: Please do not remove -->
<script src="/js/jquery-1.9.1.js"></script>
<script src="/js/virtual-remote.js"></script>
<script type="text/javascript">  
  jsMote = new JsMote();
  
  jsMote.addNode({
    id : "0x0001",
    led : false,
    light : 44,
    temperature : 22,
    delay : 500
  });
  
  jsMote.addNode({
    id : "0x0002",
    led : false,
    light : 9,
    temperature : 29,
    delay : 300
  });

  jsMote.addNode({
    id : "0x0003",
    led : false,
    light : 144,
    temperature : 21,
    delay : 550
  });

  jsMote.addNode({
    id : "0x0004",
    led : false,
    light : 245,
    temperature : 33,
    delay : 200
  });
</script>
<!-- End of Configuration -->
<script type="text/javascript">   
  
  Array.prototype.hasGravity = function(id) {
    var result = -1;
    for(var index = 0; index < this.length; index++) { 
      if(this[index][0] == id) {
        result = index;
        break;
      }
    }
    return result;
  }


  var Nodes = []; 

  function Node(id) {
    
    var id = id;

    this.x;
    this.y;

    var gravity = new Array();
    var fixed = false;
    var self = this;

    this.setPosition = function(x,y)  {
      if(!fixed) {
        clearNode(this.x, this.y);
        this.x = x;
        this.y = y;
        drawNode(this.x,this.y, id, fixed ? "#0FFF88" : "#FF8888");
      }
      else {
        drawNode(this.x,this.y, id, fixed ? "#0FFF88" : "#FF8888");
      }
    }

    this.getId = function() {
      return id;
    }

    this.addGravity = function(to, lqi) {
      var gravityIndex = gravity.hasGravity(to.getId());
      if(gravityIndex > -1) {
        var weights = gravity[gravityIndex][1];
        weights.push(lqi);
        if(weights.length > 10) {
          weights.splice(0,1);
        }
        var meanGravity = 0;
        for(var weight = 0; weight < weights.length; weight++) {
          meanGravity += weights[weight];
        }
        gravity[gravityIndex][2] = (meanGravity/weights.length)
      }
      else {
        gravity.push([to.getId(), [lqi], lqi]);
      }
    }

    this.getGravity = function() {
      var result = [];
      for(var i = 0; i < gravity.length; i++) {
        result.push( [gravity[i][0], gravity[i][2]] );
      }
      return result;
    }

    this.toggleFixed = function() {
      fixed = fixed ? false : true;
      drawNode(this.x,this.y, id, fixed ? "#0FFF88" : "#FF8888");
    }

    return function() {
      var unique = true;
      $.each(Nodes, function(index, node) {
        if(node.getId() == self.getId())
          unique = false;
      });
      if(!unique) {
        throw new Error("Node id is already in Array. Node id must be unique!")
      }
      else {
        Nodes.push(self);
        arrangeNodes();
      }
    }()
  }

  function drawNode(x, y, id, color) {
    var context = $("#localization")[0].getContext('2d');
    context.fillStyle = color;
    context.fillRect(x,y,50,50);

    context.fillStyle = "#000000";
    context.font = "10px Arial";
    context.fillText(id, x+5, y+25);
  }

  function clearNode(x, y) {
    var context = $("#localization")[0].getContext('2d');
    context.clearRect(x,y,50,50);
  }

  function calculatePosition(from, to, metric) {
    var linkQuality = Math.sqrt(Math.pow(metric-255, 2))/255;
    from.addGravity(to, linkQuality);
    recalculatePosition(from);
  }

  function recalculatePosition(node) {
    drawBoundingboxes(node, node.getGravity());
  }

  function drawBoundingboxes(node, gravity) {
    var maxDistance = (Math.min($("#localization").width()/2-50,$("#localization").height()/2-50));
    for(var i = 0; i < gravity.length; i++) {
      var boxRadius = maxDistance*gravity[i][1];
      var context = $("#localization")[0].getContext('2d');
          context.fillStyle = "#FF0000";
          context.rect((node.x+25)-boxRadius,(node.y+25)-boxRadius,boxRadius*2, boxRadius*2);
          context.stroke();
    }
  }

  function arrangeNodes() {
    var context = $("#localization")[0].getContext('2d');
    context.clearRect(0,0,$("#localization").width(),$("#localization").height());

    var radius = Math.min($("#localization").width()/2-50,$("#localization").height()/2-50);
    var center = {
      x : ($("#localization").width()-50)/2,
      y : ($("#localization").height()-50)/2
    };

    for (var i = 0; i < Nodes.length; i++)
    {
      var x = center.x + radius * Math.cos(2 * Math.PI * i / Nodes.length);
      var y = center.y + radius * Math.sin(2 * Math.PI * i / Nodes.length); 

      Nodes[i].setPosition(x,y);
    }
  }

  function getNodeById(id) {
    for(var node = 0; node < Nodes.length; node++) {
      if(Nodes[node].getId() == id)
        return node;
    }
  }

  $( document ).ready(function() {
    jsMote.alert("Find me..", function(id, message) {
      if(Nodes.length < 1) {
        new Node(id.split(":")[3]).toggleFixed();
      }
      else {
        new Node(id.split(":")[3]);
      }
    });
  });

  function localization() {
    jsMote.broadcast("Where am I?", function(id, message, from, to, metric, clock) {
      calculatePosition(Nodes[getNodeById(from)], Nodes[getNodeById(to)], metric);
    });
  }

</script>
</head>
<body>
  <h1>Localization</h1>
  <canvas id="localization" width="800" height="600"></canvas>
  <button onclick="localization();">Start Localization Round</button>
</body>
</html>