{% extends 'layout.html' %}

{% block head %}
<link rel="stylesheet" href="/css/codemirror.css">
{% parent %}
<script src="/js/codemirror.js"></script>
<script src="/js/mode/css.js"></script>
<script src="/js/mode/xml.js"></script>
<script src="/js/mode/javascript.js"></script>
<script src="/js/mode/htmlmixed.js"></script>
<script type="text/javascript">
	$( document ).ready(function() {
		var delay;
		var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
			mode: 'text/html',
			tabMode: 'indent'
		});

		editor.on("change", function() {
			clearTimeout(delay);
			delay = setTimeout(updatePreview, 300);
		});

		window.onbeforeunload = function(e) {
			$.ajax({
			  type: 'POST',
			  url: '/experiment/close/connection',
			  success: function (message) {
			  	console.log(message);
			  	return
			  },
			  async:false
			});
		};
	
		function updatePreview() {
			var previewFrame = document.getElementById("preview");
			var preview = previewFrame.contentDocument || previewFrame.contentWindow.document;
			preview.open();
			preview.write(editor.getValue());
			preview.close();
		}

		setTimeout(updatePreview, 300);

		$.post('/experiment/start/listen/{{ experiment._id.toString() }}');
	});
</script>
{% endblock %}

{% block content %}
<div class="sixteen wide column">
	<h1><i class="big lab icon"></i>{{ experiment.name }}</h1>
	<div class="ui divider"></div>
</div>
<div class="sixteen wide column">
	<label>Running Experiment:</label><br>
	<iframe id="preview"></iframe>  
</div>
<div class="sixteen wide column">
	<div class="ui top attached tabular menu">
		<a class="active item">
			Project settings
		</a>
		<a class="item">
			Community
		</a>
	</div>
	<div class="ui bottom attached segment">
		<form method="POST" action="/{{ email }}/experiment/{{ experiment._id.toString() }}/save">
		<label>Project code:</label>
		<div class="field">
			<textarea id="code" name="code">{{ experiment.code }}</textarea>
		</div>   
		<div class="ui divider"></div>
		<button type="submit" class="ui blue button">Save</button> 
	</div>
</div>
{% endblock %}